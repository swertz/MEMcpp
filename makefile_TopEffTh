#### Common variables

source_dir := src/
include_dir := interface/
objs_dir := objs/

CXXFLAGS := -O3 -g -Wall $(shell root-config --cflags) $(shell lhapdf-config --cflags) -I$(include_dir)
LDFLAGS := $(shell root-config --libs) -lGenVector $(shell lhapdf-config --ldflags) -lcuba -lDelphes
CXX := g++

_common_objs := binnedTF.o jacobianD.o MEEvent.o MEWeight.o transferFunction.o utils.o
common_objs := $(patsubst %,$(objs_dir)/%,$(_common_objs))
_common_deps := binnedTF.h jacobianD.h MEEvent.h MEWeight.h transferFunction.h utils.h
common_deps := $(patsubst %,$(include_dir)/%,$(common_deps))

#### TopEffTh specific variables

topeffth_proc_dir := MatrixElements/cpp_TopEffTh_pp_ttx_epem_NP2_QED1/
topeffth_me_dir := $(topeffth_proc_dir)/SubProcesses/P1_Sigma_TopEffTh_gg_epvebemvexbx/
topeffth_proc_obj := $(topeffth_me_dir)/cpp_TopEffTh_pp_ttx_epem_NP2_QED1.o

topeffth_dir := TopEffTh/
topeffth_exec := $(topeffth_dir)/ME_TopEffTh
_topeffth_objs := Integrand_TopEffTh.o ME_TopEffTh_main.o
topeffth_objs := $(patsubst %,$(topeffth_dir)/%,$(_topeffth_objs))

##### Common targets

all: topeffth

$(objs_dir)/%.o: $(source_dir)/%.cpp $(common_deps) | $(objs_dir)
	$(CXX) -c $< -o $@ $(CXXFLAGS) -I$(topeffth_proc_dir)

$(objs_dir):
	if [ ! -d $(objs_dir) ]; then mkdir $(objs_dir); fi

#### TopEffTh specific targets

$(topeffth_proc_obj): $(topeffth_me_dir)/*.cc
	pushd $(topeffth_me_dir) && make && pushd

topeffth: $(topeffth_exec)

$(topeffth_dir)/%.o: $(topeffth_dir)/%.cpp $(common_deps)
	$(CXX) -c $< -o $@ $(CXXFLAGS) -I$(topeffth_proc_dir)

$(topeffth_exec): $(common_objs) $(topeffth_objs) $(topeffth_proc_obj) 
	$(CXX) -o $(topeffth_exec) $^ $(LDFLAGS) -L$(topeffth_proc_dir)/lib -lmodel_TopEffTh

#### Clean targets

.PHONY: clean clean_topeffth

clean: clean_topeffth
	-rm $(objs_dir)/*.o
	-if [ -d $(objs_dir) -a ! "$(ls -A $(objs_dir))" ]; then rmdir $(objs_dir); fi

clean_topeffth:
	-rm $(topeffth_dir)/*.o
	-if [ -e $(topeffth_exec) ]; then rm $(topeffth_exec); fi
